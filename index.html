<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Virtual Accountability</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
      background: #0f0f0f;
      color: #ffffff;
    }

    .container {
      max-width: 460px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 28px;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .title {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #1b1b1b;
      color: #bdbdbd;
      border: 1px solid #2a2a2a;
      white-space: nowrap;
    }

    .card {
      background: #141414;
      border: 1px solid #242424;
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 14px;
    }

    .label {
      font-size: 12px;
      color: #a9a9a9;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.9px;
    }

    .rule {
      font-size: 16px;
      line-height: 1.35;
      font-weight: 650;
    }

    .sub {
      margin-top: 10px;
      font-size: 13px;
      color: #bdbdbd;
      line-height: 1.35;
    }

    .status {
      margin-top: 16px;
      border-radius: 14px;
      padding: 14px;
      background: #151515;
      border: 1px solid #242424;
      text-align: left;
    }

    .statusTitle {
      font-weight: 750;
      margin-bottom: 6px;
      font-size: 16px;
    }

    .statusText {
      color: #bdbdbd;
      font-size: 13px;
      line-height: 1.35;
    }

    .row {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }

    .btn {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid #2a2a2a;
      background: #1a1a1a;
      color: white;
      font-weight: 700;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:active { transform: translateY(1px); }

    .btnPrimary {
      background: #ffffff;
      color: #0f0f0f;
      border-color: #ffffff;
    }

    .btnGhost {
      background: transparent;
      color: #d6d6d6;
    }

    .tiny {
      margin-top: 10px;
      font-size: 12px;
      color: #8f8f8f;
    }

    .linkBtn {
      background: transparent;
      border: none;
      color: #bdbdbd;
      cursor: pointer;
      padding: 0;
      font-size: 13px;
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .muted { color: #9a9a9a; }

    .kpiRow {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
      margin-bottom: 14px;
    }

    .kpi {
      background: #141414;
      border: 1px solid #242424;
      border-radius: 14px;
      padding: 12px;
      text-align: center;
    }

    .kpiNum {
      font-weight: 850;
      font-size: 18px;
      margin-bottom: 4px;
    }

    .kpiLab {
      font-size: 11px;
      color: #a9a9a9;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .badge {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #2a2a2a;
      background: #1b1b1b;
      color: #cfcfcf;
      display: inline-block;
    }

    .badgeGreen { border-color:#1f3a2a; background:#122019; color:#9fe7c0; }
    .badgeRed { border-color:#3a1f1f; background:#201212; color:#f2a1a1; }
  </style>
</head>
<body>
  <div class="container" id="app"></div>

  <script>
    // Fake data for now (we replace this with DB + Whop later)
    const state = {
      weekLabel: "Mon → Sun",
      userRule: "No social media before 6pm",
      nextWeekRule: "",
      partner: { initial: "J", name: "James R.", handle: "@jamesruns" },
      partnerRule: "Gym 4× this week",
      statusText: "Waiting for Sunday confirmations to open.",
      confirmWindowOpen: false, // later: auto true on Sunday
      youConfirmedPartner: null, // null | "pass" | "fail"
      partnerConfirmedYou: null, // null | "pass" | "fail"
      weekOutcome: "pending", // "pending" | "passed" | "missed"
      strikes: 0, // 0-3
      isPaused: false,
      weekId: "", // format YYYY-MM-DD (Monday start)
      confirmCutoffISO: "", // ISO string for Sunday 11:59pm local
      finalizedWeekId: "", // prevents double-strikes on refresh
      history: {
        totalWeeks: 0,
        passed: 0,
        missed: 0,
        strikes: "0/3",
        pastWeeks: []
      }
    };


    function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    const STORAGE_KEY = "va_app_state_v1";
    
    function loadSavedState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function getLocalISODate(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }
    
    // Returns a Date for Monday 00:00 of the current week (local time)
    function getWeekMonday(now) {
      const d = new Date(now);
      d.setHours(0, 0, 0, 0);
      const day = d.getDay(); // 0 Sun .. 6 Sat
      const diffToMonday = (day + 6) % 7; // Mon->0, Tue->1, ..., Sun->6
      d.setDate(d.getDate() - diffToMonday);
      return d;
    }
    
    function computeTiming() {
      const now = new Date();
      const mon = getWeekMonday(now);
      const newWeekId = getLocalISODate(mon);
    
      // Snapshot what we previously thought the current week was (from saved state)
      const prevWeekId = state.weekId;
      const prevCutoffISO = state.confirmCutoffISO;
    
      // If the week rolled over (usually Monday), finalize the previous week once
      if (prevWeekId && prevWeekId !== newWeekId && state.finalizedWeekId !== prevWeekId) {
        // Use the previous week context to finalize
        const holdWeekId = state.weekId;
        const holdCutoff = state.confirmCutoffISO;
    
        state.weekId = prevWeekId;
        state.confirmCutoffISO = prevCutoffISO;
    
        finalizeWeekIfNeeded();
    
        // Restore (we’re about to set the new week anyway)
        state.weekId = holdWeekId;
        state.confirmCutoffISO = holdCutoff;
      }
    
      // New week cutoff = Sunday 23:59:59.999 local time
      const cutoff = new Date(mon);
      cutoff.setDate(cutoff.getDate() + 6);
      cutoff.setHours(23, 59, 59, 999);
    
      state.weekId = newWeekId;
      state.confirmCutoffISO = cutoff.toISOString();
    
      // Confirm window open on Sunday only (local time)
      const isSunday = now.getDay() === 0;
      state.confirmWindowOpen = isSunday && now <= cutoff && !state.isPaused;
    
      // If we rolled into a new week, reset week-specific UI state and roll the rule forward
      if (prevWeekId && prevWeekId !== newWeekId) {
        if (state.nextWeekRule && state.nextWeekRule.trim()) {
          state.userRule = state.nextWeekRule;
          state.nextWeekRule = "";
        }
        state.youConfirmedPartner = null;
        state.partnerConfirmedYou = null;
        state.weekOutcome = "pending";
        state.statusText = "Waiting for Sunday confirmations to open.";
        saveState();
      }
    }

    const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

    function formatMD(d) {
      return `${MONTHS[d.getMonth()]} ${d.getDate()}`;
    }
    
    function formatWeekRange(weekId) {
      if (!weekId) return "";
      const [y, m, day] = weekId.split("-").map(Number);
      const mon = new Date(y, m - 1, day);
      mon.setHours(0, 0, 0, 0);
      const sun = new Date(mon);
      sun.setDate(mon.getDate() + 6);
      return `${formatMD(mon)} – ${formatMD(sun)}`;
    }
    
    function recomputeHistoryStats() {
      const h = state.history;
      const weeks = Array.isArray(h.pastWeeks) ? h.pastWeeks : [];
      h.totalWeeks = weeks.length;
      h.passed = weeks.filter(w => w.outcome === "Passed").length;
      h.missed = weeks.filter(w => w.outcome === "Missed").length;
      h.strikes = `${state.strikes}/3`;
    }
    
    function appendCurrentWeekToHistory() {
      const h = state.history;
      if (!Array.isArray(h.pastWeeks)) h.pastWeeks = [];
    
      // don’t duplicate the same week
      if (h.pastWeeks.some(w => w.weekId === state.weekId)) return;
    
      const outcomeLabel = state.weekOutcome === "passed" ? "Passed" : "Missed";
      const youResp = state.youConfirmedPartner ? "Responded" : "No response";
      const partnerResp = state.partnerConfirmedYou ? "Responded" : "No response";
    
      h.pastWeeks.unshift({
        weekId: state.weekId,
        range: formatWeekRange(state.weekId),
        partner: state.partner?.name || "Partner",
        rule: state.partnerRule || "",
        you: youResp,
        partnerResp: partnerResp,
        outcome: outcomeLabel
      });
    
      // keep last 12 weeks
      h.pastWeeks = h.pastWeeks.slice(0, 12);
      recomputeHistoryStats();
    }
    
    function finalizeWeekIfNeeded() {
      const now = new Date();
      const cutoff = state.confirmCutoffISO ? new Date(state.confirmCutoffISO) : null;
      if (!cutoff) return;
    
      // Only finalize after cutoff
      if (now <= cutoff) return;
    
      // Only once per week
      if (state.finalizedWeekId === state.weekId) return;
    
      // If either vote missing OR any fail, it’s a miss
      const bothVoted = !!state.youConfirmedPartner && !!state.partnerConfirmedYou;
      const bothPass = state.youConfirmedPartner === "pass" && state.partnerConfirmedYou === "pass";
    
      if (bothVoted && bothPass) {
        state.weekOutcome = "passed";
        state.statusText = "Week passed. Nice work.";
      } else {
        state.weekOutcome = "missed";
        state.strikes = Math.min(3, (state.strikes || 0) + 1);
        state.statusText = "Week missed. This adds a strike.";
    
        if (state.strikes >= 3) {
          state.isPaused = true;
          state.statusText = "You’re paused. 3 strikes. You’re removed from the partner pool.";
        }
      }
    
      // Close window and mark finalized
      state.confirmWindowOpen = false;
      state.finalizedWeekId = state.weekId;
      appendCurrentWeekToHistory();
      saveState();
    }
        
    function saveState() {
      const toSave = {
        userRule: state.userRule,
        nextWeekRule: state.nextWeekRule,
        statusText: state.statusText,
        confirmWindowOpen: state.confirmWindowOpen,
        youConfirmedPartner: state.youConfirmedPartner,
        partnerConfirmedYou: state.partnerConfirmedYou,
        weekOutcome: state.weekOutcome,
        strikes: state.strikes,
        isPaused: state.isPaused,
        finalizedWeekId: state.finalizedWeekId,
        historyPastWeeks: state.history?.pastWeeks || [],
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    }

    const saved = loadSavedState();
    if (saved) {
      if (typeof saved.userRule === "string") state.userRule = saved.userRule;
      if (typeof saved.nextWeekRule === "string") state.nextWeekRule = saved.nextWeekRule;
      if (typeof saved.statusText === "string") state.statusText = saved.statusText;
      if (typeof saved.confirmWindowOpen === "boolean") state.confirmWindowOpen = saved.confirmWindowOpen;
      if (typeof saved.youConfirmedPartner === "string" || saved.youConfirmedPartner === null) state.youConfirmedPartner = saved.youConfirmedPartner;
      if (typeof saved.partnerConfirmedYou === "string" || saved.partnerConfirmedYou === null) state.partnerConfirmedYou = saved.partnerConfirmedYou;
      if (typeof saved.weekOutcome === "string") state.weekOutcome = saved.weekOutcome;
      if (typeof saved.strikes === "number") state.strikes = saved.strikes;
      if (typeof saved.isPaused === "boolean") state.isPaused = saved.isPaused;
      if (typeof saved.finalizedWeekId === "string") state.finalizedWeekId = saved.finalizedWeekId;
      if (Array.isArray(saved.historyPastWeeks)) state.history.pastWeeks = saved.historyPastWeeks;
      recomputeHistoryStats();
    }
    
    function setRoute(route) {
      location.hash = route;
    }

    function route() {
      computeTiming();
      finalizeWeekIfNeeded();
      
      const hash = location.hash.replace("#", "") || "dashboard";
      if (hash === "confirm") return renderConfirm();
      if (hash === "history") return renderHistory();
      if (hash === "rules") return renderRules();
      return renderDashboard();
    }

    function renderDashboard() {
      const el = document.getElementById("app");
      el.innerHTML = `
        <div class="topbar">
          <div class="title">This Week</div>
          <div class="pill">${esc(state.weekLabel)}</div>
        </div>

        <div class="card">
          <div class="label">Your rule</div>
          <div class="rule">${esc(state.userRule)}</div>
          ${state.nextWeekRule && state.nextWeekRule.trim()
            ? `<div class="sub" style="margin-top:10px;"><span class="muted">Next week:</span> ${esc(state.nextWeekRule)} <span class="muted">(editable until Monday)</span></div>`
            : `<div class="sub" style="margin-top:10px;"><span class="muted">Next week:</span> not set yet</div>`
          }
          <div class="sub">Keep it specific, measurable, and easy to verify.</div>
        </div>

        <div class="card">
          <div class="label">Your partner</div>

          <div style="display:flex; align-items:center; gap:10px; margin-bottom:12px;">
            <div style="
              width:36px; height:36px; border-radius:50%;
              background:#2a2a2a; display:flex; align-items:center; justify-content:center;
              font-weight:800;
            ">${esc(state.partner.initial)}</div>

            <div>
              <div style="font-weight:800;">${esc(state.partner.name)}</div>
              <div style="font-size:12px; color:#9a9a9a;">${esc(state.partner.handle)}</div>
            </div>
          </div>

          <div class="label" style="margin-top:6px;">Partner’s rule</div>
          <div class="rule">${esc(state.partnerRule)}</div>
          <div class="sub">You’ll confirm this on Sunday.</div>
        </div>

        <div class="status">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
            <div class="statusTitle">Status</div>
            ${
              state.weekOutcome === "passed"
                ? `<span class="badge badgeGreen">Passed</span>`
                : state.weekOutcome === "missed"
                  ? `<span class="badge badgeRed">Missed</span>`
                  : `<span class="badge">Pending</span>`
            }
          </div>
          <div class="statusText">${esc(state.statusText)}</div>
          <div class="tiny" style="margin-top:8px; opacity:.7;">
            Debug: weekId=${esc(state.weekId)} finalized=${esc(state.finalizedWeekId || "none")}
          </div>
          <div class="tiny" style="margin-top:10px;">Strikes: <span style="color:#cfcfcf; font-weight:800;">${state.strikes}/3</span></div>
          ${state.youConfirmedPartner
            ? `<div class="tiny" style="margin-top:10px;">Your vote: <span style="color:#cfcfcf; font-weight:700;">${state.youConfirmedPartner.toUpperCase()}</span></div>`
            : ``
          }

          <div class="row">
            ${state.confirmWindowOpen
              ? `<button class="btn btnPrimary" type="button" id="goConfirm">Confirm partner</button>`
              : `<button class="btn btnPrimary" type="button" id="goConfirm" disabled style="opacity:.45; cursor:not-allowed;">Confirm opens Sunday</button>`
            }
            <button class="btn btnGhost" type="button" id="goHistory">History</button>
          </div>

          <div class="row" style="margin-top:10px;">
            <button class="btn" type="button" id="goRules">Manage rules</button>
          </div>

          <div class="tiny">
            Dev:
            <button class="linkBtn" id="partnerPass">partner votes pass</button>
            <span class="muted">,</span>
            <button class="linkBtn" id="partnerFail">partner votes fail</button>
            <span class="muted">,</span>
            <button class="linkBtn" id="resetWeek">reset</button>
            <span class="muted">,</span>
            <button class="linkBtn" id="resetStrikes">reset strikes</button>
          </div>
        </div>
      `;

      document.getElementById("goConfirm").onclick = () => {
        if (state.isPaused) return;
        if (!state.confirmWindowOpen) return;
        setRoute("confirm");
      };
      
      function computeOutcome() {
        // Passed only if both votes are pass
        if (state.youConfirmedPartner === "pass" && state.partnerConfirmedYou === "pass") {
          state.weekOutcome = "passed";
          state.statusText = "Week passed. Nice work.";
        } else if (state.youConfirmedPartner && state.partnerConfirmedYou) {
          state.weekOutcome = "missed";
          state.strikes = Math.min(3, (state.strikes || 0) + 1);
          state.statusText = "Week missed. This adds a strike.";
        
          if (state.strikes >= 3) {
            state.isPaused = true;
            state.statusText = "You’re paused. 3 strikes. You’re removed from the partner pool.";
          }
        } else {
          state.weekOutcome = "pending";
        }
        }
      
      document.getElementById("partnerPass").onclick = () => {
        state.partnerConfirmedYou = "pass";
        computeOutcome();
        saveState();
        route();
      };
      
      document.getElementById("partnerFail").onclick = () => {
        state.partnerConfirmedYou = "fail";
        computeOutcome();
        saveState();
        route();
      };
      
      document.getElementById("resetWeek").onclick = () => {
        state.confirmWindowOpen = false;
        state.youConfirmedPartner = null;
        state.partnerConfirmedYou = null;
        state.weekOutcome = "pending";
        state.statusText = "Waiting for Sunday confirmations to open.";
        saveState();
        route();
      };
      
      document.getElementById("resetStrikes").onclick = () => {
        state.strikes = 0;
        state.isPaused = false;
        state.statusText = "Waiting for Sunday confirmations to open.";
        saveState();
        route();
      };

      document.getElementById("goHistory").onclick = () => setRoute("history");
      document.getElementById("goRules").onclick = () => setRoute("rules");
    }

    function renderConfirm() {
      const el = document.getElementById("app");
      el.innerHTML = `
        <div class="topbar">
          <button class="linkBtn" id="backDash">← Back</button>
          <div class="pill">${esc(state.weekLabel)}</div>
        </div>

        <div class="title" style="margin-bottom:10px;">Confirm partner</div>
        <div class="muted" style="font-size:13px; margin-bottom:14px;">
          Did ${esc(state.partner.name)} follow their rule this week?
        </div>

        <div class="card">
          <div class="label">Partner’s rule</div>
          <div class="rule">${esc(state.partnerRule)}</div>
        </div>

        <div class="row">
          <button class="btn btnPrimary" type="button" id="btnPass">Pass</button>
          <button class="btn" type="button" id="btnFail">Fail</button>
        </div>

        <div class="tiny">This is fake for now. Next we’ll save this to the database.</div>
      `;

      document.getElementById("backDash").onclick = () => setRoute("dashboard");

      document.getElementById("btnPass").onclick = () => {
        state.youConfirmedPartner = "pass";
        state.statusText = "You confirmed your partner as Passed. Waiting for them to confirm you.";
        saveState();
        setRoute("dashboard");
      };

      document.getElementById("btnFail").onclick = () => {
        state.youConfirmedPartner = "fail";
        state.statusText = "You marked your partner as Failed. Waiting for them to confirm you.";
        saveState();
        setRoute("dashboard");
      };
    }

    function renderHistory() {
      const h = state.history;
      const el = document.getElementById("app");

      const list = h.pastWeeks.map(w => {
        const ok = w.outcome === "Passed";
        return `
          <div class="card">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
              <div>
                <div class="muted" style="font-size:12px; margin-bottom:6px;">${esc(w.range)}</div>
                <div style="font-weight:800; margin-bottom:6px;">${esc(w.partner)}</div>
                <div class="muted" style="font-size:13px; line-height:1.35;">“${esc(w.rule)}”</div>
              </div>
              <span class="badge ${ok ? "badgeGreen" : "badgeRed"}">${esc(w.outcome)}</span>
            </div>

            <div style="margin-top:12px; display:flex; gap:12px; font-size:12px; color:#9a9a9a;">
              <div>You: <span style="color:#cfcfcf">${esc(w.you)}</span></div>
              <div>Partner: <span style="color:#cfcfcf">${esc(w.partnerResp)}</span></div>
            </div>
          </div>
        `;
      }).join("");

      el.innerHTML = `
        <div class="topbar">
          <button class="linkBtn" id="backDash">← Back</button>
          <div class="pill">${esc(state.weekLabel)}</div>
        </div>

        <div class="title" style="margin-bottom:6px;">Your History</div>
        <div class="muted" style="font-size:13px; margin-bottom:12px;">Track your accountability journey</div>

        <div class="kpiRow">
          <div class="kpi"><div class="kpiNum">${esc(h.totalWeeks)}</div><div class="kpiLab">Total</div></div>
          <div class="kpi"><div class="kpiNum">${esc(h.passed)}</div><div class="kpiLab">Passed</div></div>
          <div class="kpi"><div class="kpiNum">${esc(h.missed)}</div><div class="kpiLab">Missed</div></div>
          <div class="kpi"><div class="kpiNum">${esc(h.strikes)}</div><div class="kpiLab">Strikes</div></div>
        </div>

        <div class="label" style="margin-top:6px;">Past weeks</div>
        ${list}
      `;

      document.getElementById("backDash").onclick = () => setRoute("dashboard");
    }
    
    function renderRules() {
      const el = document.getElementById("app");
    
      // local UI state for this screen
      const hasSavedNextRule = !!(state.nextWeekRule && state.nextWeekRule.trim());
      let isEditing = !hasSavedNextRule;
    
      function draw() {
        el.innerHTML = `
          <div class="topbar">
            <button class="linkBtn" id="backDash">← Back</button>
            <div class="pill">${esc(state.weekLabel)}</div>
          </div>
    
          <div class="title" style="margin-bottom:6px;">Weekly Rules</div>
          <div class="muted" style="font-size:13px; margin-bottom:14px;">
            Set one specific, measurable rule for next week. It locks on Monday.
          </div>
    
          <div class="card">
            <div class="label">Current week (locked)</div>
            <div class="muted" style="font-size:12px; margin-bottom:6px;">${esc(formatWeekRange(state.weekId))}</div>
            <div class="rule">${esc(state.userRule)}</div>
            <div class="sub muted">Cannot be changed</div>
          </div>
    
          <div class="card">
            <div class="label">Next week</div>
            <div class="muted" style="font-size:12px; margin-bottom:10px;">Starts Monday</div>
    
            ${
              isEditing
                ? `
                  <div class="label" style="margin-top:6px;">Set next week’s rule</div>
                  <textarea id="nextRule" rows="4" style="
                    width:100%;
                    box-sizing:border-box;
                    resize:none;
                    padding:12px;
                    border-radius:12px;
                    border:1px solid #2a2a2a;
                    background:#101010;
                    color:white;
                    font-family: inherit;
                    font-size:14px;
                    line-height:1.35;
                    outline:none;
                  " placeholder="Example: Complete 30 minutes of focused work before checking email">${esc(state.nextWeekRule || "")}</textarea>
    
                  <div style="display:flex; justify-content:space-between; margin-top:8px;">
                    <div class="tiny" id="charCount">0/200</div>
                    <div class="tiny muted">One specific rule</div>
                  </div>
    
                  <div class="row" style="margin-top:12px;">
                    <button class="btn btnPrimary" type="button" id="saveRule">Save rule</button>
                    <button class="btn btnGhost" type="button" id="cancelEdit">Cancel</button>
                  </div>
    
                  <div class="tiny" id="saveMsg" style="display:none;">Saved for next week.</div>
                `
                : `
                  <div class="label" style="margin-top:6px;">Saved rule for next week</div>
                  <div class="rule">${esc(state.nextWeekRule)}</div>
                  <div class="sub muted">You can edit this until Monday.</div>
    
                  <div class="row" style="margin-top:12px;">
                    <button class="btn" type="button" id="editNextRule">Edit next week’s rule</button>
                  </div>
                `
            }
          </div>
    
          <div class="card">
            <div class="label">How rules work</div>
            <div class="sub" style="margin-top:0;">
              1. Set one specific rule each week<br>
              2. Once the week starts (Monday), it’s locked<br>
              3. Confirm your partner on Sunday<br>
              4. Misses add strikes, 3 strikes pauses your account
            </div>
          </div>
        `;
    
        document.getElementById("backDash").onclick = () => setRoute("dashboard");
    
        if (isEditing) {
          const input = document.getElementById("nextRule");
          const count = document.getElementById("charCount");
          const msg = document.getElementById("saveMsg");
    
          function updateCount() {
            if (input.value.length > 200) input.value = input.value.slice(0, 200);
            count.textContent = `${input.value.length}/200`;
          }
          input.addEventListener("input", updateCount);
          updateCount();
    
          document.getElementById("cancelEdit").onclick = () => {
            // If nothing saved yet, cancel takes you back to dashboard
            if (!state.nextWeekRule) {
              setRoute("dashboard");
            } else {
              isEditing = false;
              draw();
            }
          };
    
          document.getElementById("saveRule").onclick = () => {
            const v = input.value.trim();
            if (!v) {
              alert("Enter a rule first.");
              return;
            }
            state.nextWeekRule = v;
            saveState();
  
            // Show a quick saved message, stay on page, and switch to non-edit view
            isEditing = false;
            draw();
          };
        } else {
          document.getElementById("editNextRule").onclick = () => {
            isEditing = true;
            draw();
          };
        }
      }
      
      draw();
    }

    window.addEventListener("hashchange", () => {
      computeTiming();
      finalizeWeekIfNeeded();
      route();
    });
    async function getWhopUserToken() {
      // Whop SDK injects auth context inside the embedded app
      const r = await fetch("/api/whop-auth");
      const j = await r.json();
      return j.token;
    }
    route();
    
    fetch("https://whop-hello.vercel.app/api/me/partner")
      .then(r => r.json())
      .then(data => {
        if (!data.ok || !data.hasPartner) return;
    
        state.partner = {
          initial: data.pairing.partner_name[0],
          name: data.pairing.partner_name,
          handle: ""
        };
    
        route();
      })
      .catch(err => {
        console.error("PARTNER FETCH FAILED", err);
      });

      })
      .catch(console.error);
  </script>
</body>
</html>




